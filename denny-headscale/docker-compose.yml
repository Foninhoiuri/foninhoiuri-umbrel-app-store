version: '3.7'

services:
  headscale:
    image: headscale/headscale:latest
    pull_policy: always
    container_name: headscale
    restart: unless-stopped
    command: headscale serve
    volumes:
      - ${APP_DATA_DIR}/headscale/config:/etc/headscale
      - ${APP_DATA_DIR}/headscale/data:/var/lib/headscale
    labels:
      - traefik.enable=true
      - traefik.http.routers.headscale-rtr.rule=PathPrefix(`/`) # Weiterleitung auf den Haupt-API-Endpunkt
      - traefik.http.services.headscale-svc.loadbalancer.server.port=8080
    ports:
      - 5000:8080 # Headscale HTTP API port (neuer Port)

  headscale-ui:
    image: ghcr.io/gurucomputing/headscale-ui:latest
    pull_policy: always
    container_name: headscale-ui
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.headscale-ui-rtr.rule=Host(`umbrel-2.local`) # Direktzugriff auf den Hostname
      - traefik.http.routers.headscale-ui-rtr.entrypoints=websecure
      - traefik.http.services.headscale-ui-svc.loadbalancer.server.port=8443
    ports:
      - 8383:8443 # Headscale UI HTTPS port (jetzt auf 8383)

  traefik:
    image: traefik:latest
    pull_policy: always
    restart: unless-stopped
    container_name: traefik
    command:
      - --api.insecure=true # remove in production
      - --providers.docker
      - --entrypoints.web.address=:5000
      - --entrypoints.websecure.address=:8444
      - --global.sendAnonymousUsage=false
    ports:
      - 5000:5000  # Neuer HTTP-Port für Traefik
      - 8444:8444  # Neuer HTTPS-Port für Traefik
      - 9090:9090  # Traefik web UI (API-Insecure) auf einem anderen Port
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${APP_DATA_DIR}/traefik/certificates:/certificates
