version: '3.7'

services:
  headscale:
    image: headscale/headscale:latest
    container_name: headscale
    restart: unless-stopped
    command: headscale serve --config /etc/headscale/config.yaml
    volumes:
      - ${APP_DATA_DIR}/headscale/config:/etc/headscale
      - ${APP_DATA_DIR}/headscale/data:/var/lib/headscale
    labels:
      - traefik.enable=true
      - traefik.http.routers.headscale-rtr.rule=PathPrefix(`/`)
      - traefik.http.services.headscale-svc.loadbalancer.server.port=8080
    expose:
      - "8080" # Port, auf dem Headscale intern läuft

  headscale-ui:
    image: ghcr.io/gurucomputing/headscale-ui:latest
    container_name: headscale-ui
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/headscale-ui/config:/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.headscale-ui-rtr.rule=PathPrefix(`/web`)
      - traefik.http.services.headscale-ui-svc.loadbalancer.server.port=8383
    expose:
      - "8383" # Port, auf dem die UI läuft (intern)

  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.insecure=true  # Entfernen in der Produktion!
      - --providers.docker
      - --entrypoints.web.address=:8081
      - --entrypoints.websecure.address=:8443
      - --global.sendAnonymousUsage=false
    ports:
      - "8081:8081"  # Webport für Traefik
      - "8443:8443"  # HTTPS-Port für Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${APP_DATA_DIR}/traefik/certificates:/certificates
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-api.rule=PathPrefix(`/traefik`)"
      - "traefik.http.services.traefik-api.loadbalancer.server.port=8080"
      - "traefik.http.routers.headscale-ui-rtr.entrypoints=websecure"
      - "traefik.http.routers.headscale-ui-rtr.tls=true"

  # Optional: Weitere Services für andere Anwendungen können hier hinzugefügt werden.
