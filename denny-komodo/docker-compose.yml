version: '3.7'

services:
  app_proxy:
    environment:
      APP_HOST: denny-komodo_web_1
      APP_PORT: 9120

  postgres:
    image: ghcr.io/ferretdb/postgres-documentdb
    user: "1000:1000"
    labels:
      komodo.skip:
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: komodo_user
      POSTGRES_PASSWORD: komodo_pass
      POSTGRES_DB: postgres

  ferretdb:
    image: ghcr.io/ferretdb/ferretdb
    user: "1000:1000"
    labels:
      komodo.skip:
    restart: on-failure
    depends_on:
      - postgres
    volumes:
      - ${APP_DATA_DIR}/data/ferretdb:/state
    environment:
      FERRETDB_POSTGRESQL_URL: postgres://komodo_user:komodo_pass@postgres:5432/postgres

  web:
    image: ghcr.io/moghtech/komodo-core:latest
    user: "1000:1000"
    labels:
      komodo.skip:
    restart: on-failure
    depends_on:
      - ferretdb
    environment:
      KOMODO_DATABASE_ADDRESS: ferretdb:27017
      KOMODO_DATABASE_USERNAME: komodo_user
      KOMODO_DATABASE_PASSWORD: komodo_pass
      KOMODO_PASSKEY: J49xLpMnI2CvPKe7XgRwQaHc0vUzEynA
      TZ: Etc/UTC
      KOMODO_HOST: https://demo.komo.do
      KOMODO_TITLE: Komodo
      KOMODO_FIRST_SERVER: https://periphery:8120
      KOMODO_DISABLE_CONFIRM_DIALOG: "false"
      KOMODO_MONITORING_INTERVAL: 15-sec
      KOMODO_RESOURCE_POLL_INTERVAL: 1-hr
      KOMODO_WEBHOOK_SECRET: A1zPuRo38XqYBmKrN5GwQeLsVDjTKf9o
      KOMODO_JWT_SECRET: Dq47XNgvP81zAeMbUCjF3rLtYo9wVsQI
      KOMODO_JWT_TTL: 1-day
      KOMODO_LOCAL_AUTH: "true"
      KOMODO_DISABLE_USER_REGISTRATION: "false"
      KOMODO_ENABLE_NEW_USERS: "false"
      KOMODO_DISABLE_NON_ADMIN_CREATE: "false"
      KOMODO_TRANSPARENT_MODE: "false"
      KOMODO_LOGGING_PRETTY: "false"
      KOMODO_PRETTY_STARTUP_CONFIG: "false"
      KOMODO_OIDC_ENABLED: "false"
      KOMODO_GITHUB_OAUTH_ENABLED: "false"
      KOMODO_GOOGLE_OAUTH_ENABLED: "false"
      KOMODO_AWS_ACCESS_KEY_ID:
      KOMODO_AWS_SECRET_ACCESS_KEY:
    volumes:
      - ${APP_DATA_DIR}/data/repo-cache:/repo-cache

  periphery:
    image: ghcr.io/moghtech/komodo-periphery:latest
    user: "1000:1000"
    labels:
      komodo.skip:
    restart: on-failure
    environment:
      PERIPHERY_ROOT_DIRECTORY: /etc/komodo
      PERIPHERY_PASSKEYS: J49xLpMnI2CvPKe7XgRwQaHc0vUzEynA
      PERIPHERY_DISABLE_TERMINALS: "false"
      PERIPHERY_SSL_ENABLED: "true"
      PERIPHERY_INCLUDE_DISK_MOUNTS: /etc/hostname
      PERIPHERY_LOGGING_PRETTY: "false"
      PERIPHERY_PRETTY_STARTUP_CONFIG: "false"
      TZ: Etc/UTC
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc
      - ${APP_DATA_DIR}/data/periphery:/etc/komodo
