version: '3.7'

services:
  app_proxy:
    environment:
      APP_HOST: denny-teable_app_1
      APP_PORT: 3000

  app:
    image: ghcr.io/teableio/teable-ee:latest
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/assets:/app/.assets:rw
    environment:
      - NEXT_ENV_IMAGES_ALL_REMOTE=true
      - POSTGRES_PASSWORD=G7xP4zQw9NfK
      - REDIS_PASSWORD=R3d1s$S3cret!2025
      - SECRET_KEY=S3cR3tK3y_2025_Te@ble!
      - PUBLIC_ORIGIN=http://umbrel-2.local:8599
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=teable
      - POSTGRES_USER=teable
      - REDIS_HOST=cache
      - REDIS_PORT=6379
      - REDIS_DB=0
      - PRISMA_DATABASE_URL=postgresql://teable:G7xP4zQw9NfK@db:5432/teable
      - BACKEND_CACHE_PROVIDER=redis
      - BACKEND_CACHE_REDIS_URI=redis://default:R3d1s$S3cret!2025@cache:6379/0
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      start_period: 5s
      interval: 5s
      timeout: 3s
      retries: 3

  db:
    image: postgres:15.4
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/db:/var/lib/postgresql/data:rw
    environment:
      - POSTGRES_DB=teable
      - POSTGRES_USER=teable
      - POSTGRES_PASSWORD=G7xP4zQw9NfK
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'pg_isready -U teable -d teable'"]
      interval: 10s
      timeout: 3s
      retries: 3

  cache:
    image: redis:7.2.4
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/cache:/data:rw
    command: redis-server --appendonly yes --requirepass R3d1s$S3cret!2025
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "R3d1s$S3cret!2025", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3