version: '3.7'

services:
  app_proxy:
    environment:
      APP_HOST: denny-endurain_web_1
      APP_PORT: 8080

  web:
    image: ghcr.io/joaovitoriasilva/endurain:v0.10.0@sha256:47a3025c702ddfb8c475e8006f07733b878fbd8057568404d85bbc785bb432c3
    restart: on-failure
    environment:
      - TZ=Europe/Berlin
      - DB_TYPE=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=endurain
      - DB_PASSWORD=changeme
      - SECRET_KEY=changeme
      - GEOCODES_MAPS_API=changeme
      - ENDURAIN_HOST=http://localhost:8080
      - BEHIND_PROXY=true
    volumes:
      - ${APP_DATA_DIR}/data/user_images:/app/backend/user_images
      - ${APP_DATA_DIR}/data/bulk_import:/app/backend/files/bulk_import
      - ${APP_DATA_DIR}/data/processed_files:/app/backend/files/processed
      - ${APP_DATA_DIR}/data/logs:/app/backend/logs
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:15@sha256:fe45ed1a824b81c0c9c605890963b67501758ca8c946db89089c85ce0f88e974
    restart: on-failure
    environment:
      - POSTGRES_DB=endurain
      - POSTGRES_USER=endurain
      - POSTGRES_PASSWORD=changeme
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ${APP_DATA_DIR}/data/postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U endurain"]
      interval: 5s
      timeout: 5s
      retries: 5