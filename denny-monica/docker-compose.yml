version: '3.7'

services:
  app_proxy:
    environment:
      APP_HOST: denny-monica_web_1
      APP_PORT: 80

  web:
    image: monica:4.1.2-apache@sha256:b1b332533066ac3d8daddc58acdcbe0feeeb8ea6dd983c27d316eb6e04e90571
    depends_on:
      - db
    environment:
      - APP_ENV=production
      - DB_HOST=db
      - DB_DATABASE=monica
      - DB_USERNAME=monica
      - DB_PASSWORD=secret
      - LOG_CHANNEL=stderr
      - CACHE_DRIVER=database
      - SESSION_DRIVER=database
      - QUEUE_DRIVER=sync
      - FORCE_SSL=false
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/monica:/var/www/html/storage:rw

  db:
    image: mariadb:11.4-noble@sha256:5dfb3093333fa0ea53194ddef0a2bfa21d3b1e1353bd228b22610cd6fc0c04da
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_DATABASE=monica
      - MYSQL_USER=monica
      - MYSQL_PASSWORD=secret
    volumes:
      - ${APP_DATA_DIR}/data/db:/var/lib/mysql:rw
    restart: on-failure
